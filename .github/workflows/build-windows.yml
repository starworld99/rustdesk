name: Build Windows RustDesk Client

on:
  workflow_dispatch:

env:
  RENDEZVOUS_SERVER: xyz.bsp.cn
  RELAY_SERVER: xyz.bsp.cn:21117
  RS_PUB_KEY: B70FbvLRUyE1K4QSYizzi8jypvvfEERdVbBU61EE8Us=
  API_SERVER: https://xyz.bsp.cn/rustdesk-hbbs

jobs:
  build-windows:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive   # 自动拉取子模块

    - name: Install Rust target
      run: rustup target add x86_64-pc-windows-gnu

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y mingw-w64 zip

    - name: Set custom server environment
      run: |
        echo "RENDEZVOUS_SERVER=${{ env.RENDEZVOUS_SERVER }}" >> $GITHUB_ENV
        echo "RELAY_SERVER=${{ env.RELAY_SERVER }}" >> $GITHUB_ENV
        echo "RS_PUB_KEY=${{ env.RS_PUB_KEY }}" >> $GITHUB_ENV
        echo "API_SERVER=${{ env.API_SERVER }}" >> $GITHUB_ENV

    - name: Build Windows client
      run: |
        cargo build --release --target x86_64-pc-windows-gnu

    - name: Package executable
      run: |
        mkdir -p release
        cp target/x86_64-pc-windows-gnu/release/rustdesk.exe release/
        cd release && zip rustdesk-windows.zip rustdesk.exe

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-windows
        path: release/rustdesk-windows.zip
